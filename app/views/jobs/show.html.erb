<div class="max-w-4xl mx-auto py-8 px-4">
  <div class="mb-6">
    <%= link_to "‚Üê Back to Job Board", jobs_path, class: "text-blue-600 hover:text-blue-800" %>
  </div>

  <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2"><%= @job.title %></h1>
        <p class="text-xl text-gray-700 mb-2"><%= @job.company %></p>
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <% if @job.location.present? %>
            <span>üìç <%= @job.location %></span>
          <% end %>
          <% if @job.remote? %>
            <span class="px-2 py-1 bg-green-100 text-green-800 rounded font-medium">Remote</span>
          <% end %>
          <% if @job.posted_at %>
            <span>Posted <%= time_ago_in_words(@job.posted_at) %> ago</span>
          <% end %>
          <% if @job.status != 'suggested' %>
            <span class="px-2 py-1 rounded font-medium <%= case @job.status 
              when 'applied' then 'bg-green-100 text-green-800'
              when 'rejected' then 'bg-red-100 text-red-800'
              when 'ignored' then 'bg-gray-100 text-gray-800'
              when 'exported' then 'bg-purple-100 text-purple-800'
              end %>">
              <%= @job.status.titleize %>
            </span>
          <% end %>
        </div>
      </div>
      <div class="flex flex-col gap-3">
        <%= link_to "Apply on Company Site ‚Üí", @job.url, target: "_blank", rel: "noopener noreferrer", class: "px-6 py-3 text-white font-semibold rounded-lg transition-colors text-center", style: "background-color: #16a34a;" %>
        
        <% if @job.generated_today? %>
          <div class="px-6 py-3 bg-green-100 text-green-800 font-semibold rounded-lg text-center">
            ‚úì Generated <%= time_ago_in_words(@job.exported_at) %> ago
          </div>
        <% else %>
          <%= button_to "Tailor & Export PDFs", tailor_job_path(@job), method: :post, class: "px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors" %>
        <% end %>
        
        <div class="flex gap-2 mt-2">
          <%= button_to "Applied", applied_job_path(@job), method: :patch, class: "flex-1 px-4 py-2 text-sm font-semibold rounded transition-colors", style: "background-color: #16a34a; color: white;" %>
          <%= button_to "Reject", rejected_job_path(@job), method: :patch, class: "flex-1 px-4 py-2 text-sm font-semibold rounded transition-colors", style: "background-color: #dc2626; color: white;" %>
          <%= button_to "Ignore", ignore_job_path(@job), method: :patch, class: "flex-1 px-4 py-2 text-sm font-semibold rounded transition-colors", style: "background-color: #4b5563; color: white;" %>
        </div>
      </div>
    </div>

    <% if @scan_results[:warnings].any? || @scan_results[:blocking].any? %>
      <div class="mb-4 space-y-2">
        <% @scan_results[:blocking].each do |flag| %>
          <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded text-sm">
            <span class="text-red-500 mr-2">üö´</span>
            <span class="font-semibold text-red-800"><%= flag[:message] %></span>
          </div>
        <% end %>

        <% @scan_results[:warnings].each do |flag| %>
          <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded text-sm">
            <span class="text-yellow-500 mr-2">‚ö†Ô∏è</span>
            <span class="font-semibold text-yellow-800"><%= flag[:message] %></span>
            <% if flag[:note] %>
              <span class="text-yellow-700"> - <%= flag[:note] %></span>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="max-w-none">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Job Description</h2>
      <div class="prose prose-sm prose-headings:font-bold prose-headings:text-gray-900 prose-p:text-gray-700 prose-p:leading-relaxed prose-ul:list-disc prose-ul:pl-5 prose-li:text-gray-700 prose-a:text-blue-600 prose-a:underline max-w-none bg-white p-6 rounded-lg border border-gray-200">
        <%= simple_format(@job.description, {}, wrapper_tag: "div") %>
      </div>
    </div>
  </div>

  <!-- Skill Assessment Section -->
  <div class="max-w-none mt-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Skill Assessment</h2>
    
    <!-- Summary Banner -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>
        <span class="text-blue-800 font-medium">
          This job will tailor using <%= @skill_summary[:total_effective] %> verified skills; 
          <%= @skill_summary[:excluded_count] %> excluded.
        </span>
      </div>
    </div>
    
    <!-- Proficiency Scale Legend -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
      <h3 class="text-sm font-medium text-blue-900 mb-2">Proficiency Scale</h3>
      <div class="grid grid-cols-5 gap-2 text-xs text-blue-800">
        <div><strong>1 - Beginner:</strong> Basic understanding, can follow tutorials</div>
        <div><strong>2 - Novice:</strong> Can work with guidance, limited experience</div>
        <div><strong>3 - Intermediate:</strong> Can work independently, solid foundation</div>
        <div><strong>4 - Advanced:</strong> Can solve complex problems, mentor others</div>
        <div><strong>5 - Expert:</strong> Deep expertise, can architect solutions</div>
      </div>
      <p class="text-xs text-blue-700 mt-2">
        <strong>Threshold:</strong> Skills rated 3+ (Intermediate or above) are included in your resume.
      </p>
    </div>
    
    <!-- Skills Table -->
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skill</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Have</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proficiency</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @extracted_skills.each do |skill| %>
            <% assessment = @existing_assessments[skill] %>
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                <%= skill.titleize %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <%= form_with model: assessment || @job.job_skill_assessments.build, 
                              url: assessment ? job_job_skill_assessment_path(@job, assessment) : job_job_skill_assessments_path(@job),
                              method: assessment ? :patch : :post,
                              local: true, 
                              class: "inline-block" do |form| %>
                  <%= form.hidden_field :skill_name, value: skill %>
                  <%= form.select :have, 
                                  options_for_select([['Yes', true], ['No', false]], assessment&.have),
                                  { prompt: 'Select...' },
                                  { class: "text-sm border-gray-300 rounded-md", 
                                    onchange: "this.form.submit()" } %>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <% if assessment&.have? %>
                  <%= form_with model: assessment, 
                                url: job_job_skill_assessment_path(@job, assessment),
                                method: :patch,
                                local: true, 
                                class: "inline-block" do |form| %>
                    <%= form.hidden_field :skill_name, value: skill %>
                    <%= form.hidden_field :have, value: true %>
                    <%= form.select :proficiency, 
                                    options_for_select([
                                      ['1 - Beginner', 1],
                                      ['2 - Novice', 2], 
                                      ['3 - Intermediate', 3],
                                      ['4 - Advanced', 4],
                                      ['5 - Expert', 5]
                                    ], assessment.proficiency),
                                    { prompt: 'Select proficiency...' },
                                    { class: "text-sm border-gray-300 rounded-md", 
                                      onchange: "this.form.submit()" } %>
                  <% end %>
                <% else %>
                  <span class="text-gray-400 text-sm">N/A</span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <% if assessment %>
                  <span class="text-green-600">‚úì Saved</span>
                <% else %>
                  <span class="text-gray-400">Not set</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      
      <% if @extracted_skills.empty? %>
        <div class="px-6 py-4 text-center text-gray-500">
          No common skills detected in job description.
        </div>
      <% end %>
    </div>
  </div>

  <!-- Notes Section -->
  <% if @job.notes.present? || @job.rejected_reason.present? %>
    <div class="bg-white border border-gray-200 rounded-lg p-6 mt-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Notes</h2>
      <% if @job.rejected_reason.present? %>
        <div class="mb-3">
          <strong class="text-red-700">Rejection Reason:</strong>
          <p class="text-gray-700"><%= @job.rejected_reason %></p>
        </div>
      <% end %>
      <% if @job.notes.present? %>
        <div class="mb-3">
          <strong class="text-gray-700">Notes:</strong>
          <p class="text-gray-700"><%= @job.notes %></p>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

