<div class="max-w-6xl mx-auto py-8 px-4">
  <div class="mb-8 flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Job Board</h1>
      <p class="text-gray-600">Curated job postings from selected companies. Click "Tailor & Export" to generate documents.</p>
    </div>
    <div class="text-right">
      <%= button_to "Check for New Jobs", fetch_jobs_path, method: :post, class: "px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors", data: { turbo_frame: "_top" } %>
      <% if @last_fetch %>
        <p class="text-xs text-gray-500 mt-2">Last checked <%= time_ago_in_words(@last_fetch) %> ago</p>
      <% else %>
        <p class="text-xs text-gray-500 mt-2">Never checked yet</p>
      <% end %>
    </div>
  </div>

  <!-- Status Tabs -->
  <div class="mb-6 border-b border-gray-200">
    <nav class="-mb-px flex space-x-8">
      <%= link_to jobs_path(status: 'suggested'), class: "whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm #{params[:status] == 'suggested' || params[:status].blank? ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}" do %>
        Active
        <% if @status_counts[:suggested] > 0 %>
          <span class="ml-2 py-0.5 px-2 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><%= @status_counts[:suggested] %></span>
        <% end %>
      <% end %>
      
      <%= link_to jobs_path(status: 'applied'), class: "whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm #{params[:status] == 'applied' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}" do %>
        Applied
        <% if @status_counts[:applied] > 0 %>
          <span class="ml-2 py-0.5 px-2 rounded-full text-xs font-medium bg-green-100 text-green-800"><%= @status_counts[:applied] %></span>
        <% end %>
      <% end %>
      
      <%= link_to jobs_path(status: 'rejected'), class: "whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm #{params[:status] == 'rejected' ? 'border-red-500 text-red-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}" do %>
        Rejected
        <% if @status_counts[:rejected] > 0 %>
          <span class="ml-2 py-0.5 px-2 rounded-full text-xs font-medium bg-red-100 text-red-800"><%= @status_counts[:rejected] %></span>
        <% end %>
      <% end %>
      
      <%= link_to jobs_path(status: 'ignored'), class: "whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm #{params[:status] == 'ignored' ? 'border-gray-500 text-gray-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}" do %>
        Ignored
        <% if @status_counts[:ignored] > 0 %>
          <span class="ml-2 py-0.5 px-2 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><%= @status_counts[:ignored] %></span>
        <% end %>
      <% end %>
      
      <%= link_to jobs_path(status: 'exported'), class: "whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm #{params[:status] == 'exported' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}" do %>
        Exported
        <% if @status_counts[:exported] > 0 %>
          <span class="ml-2 py-0.5 px-2 rounded-full text-xs font-medium bg-purple-100 text-purple-800"><%= @status_counts[:exported] %></span>
        <% end %>
      <% end %>
      
      <%= link_to jobs_path(status: 'all'), class: "whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm #{params[:status] == 'all' ? 'border-gray-500 text-gray-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}" do %>
        All
        <% if @status_counts[:all] > 0 %>
          <span class="ml-2 py-0.5 px-2 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><%= @status_counts[:all] %></span>
        <% end %>
      <% end %>
    </nav>
  </div>

  <!-- Search and Filters -->
  <div class="mb-6 bg-white border border-gray-200 rounded-lg p-4">
    <%= form_with url: jobs_path, method: :get, local: true, class: "space-y-4" do |form| %>
      <%= hidden_field_tag :status, params[:status] if params[:status].present? %>
      <div class="flex gap-4 items-end">
        <div class="flex-1">
          <%= form.label :q, "Search", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.text_field :q, value: params[:q], placeholder: "Company, title, or keywords...", class: "w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500" %>
        </div>
        
        <div>
          <%= form.label :days, "Posted Within", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.select :days, [["Any time", ""], ["7 days", "7"], ["14 days", "14"], ["30 days", "30"]], { selected: params[:days] }, class: "border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500" %>
        </div>
        
        <div>
          <%= form.label :min_score, "Min Score", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.number_field :min_score, value: params[:min_score], placeholder: "0-100", min: 0, max: 100, class: "w-24 border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500" %>
        </div>
        
        <div class="flex gap-2">
          <%= form.submit "Search", class: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium" %>
          <%= link_to "Clear", jobs_path, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors text-sm font-medium" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Source Counts Badge -->
  <% if @source_counts.any? %>
    <div class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
      <div class="flex items-center gap-4 flex-wrap">
        <span class="text-sm font-medium text-gray-700">Sources:</span>
        <% @source_counts.each do |source, count| %>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            <%= source.titleize %>: <%= count %>
          </span>
        <% end %>
        <span class="text-xs text-gray-500 ml-auto">Total: <%= @source_counts.values.sum %> jobs</span>
      </div>
    </div>
  <% end %>

  <% if @rules&.ui && @rules.ui['active_filter_label'].present? %>
    <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>
        <span class="text-blue-800 font-medium"><%= @rules.ui['active_filter_label'] %></span>
      </div>
    </div>
  <% end %>

  <% if @jobs.any? %>
    <div class="space-y-4">
      <% @jobs.each do |job| %>
        <div class="bg-white border border-gray-200 rounded-lg p-6 hover:border-blue-500 transition-colors">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <h2 class="text-xl font-semibold text-gray-900">
                  <%= link_to job.title, job_path(job), class: "hover:text-blue-600" %>
                </h2>
                <% if job.remote? %>
                  <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">Remote</span>
                <% end %>
                <% if job.source.present? %>
                  <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium"><%= job.source.titleize %></span>
                <% end %>
                <% if job.status != 'suggested' %>
                  <span class="px-2 py-1 rounded text-xs font-medium <%= case job.status 
                    when 'applied' then 'bg-green-100 text-green-800'
                    when 'rejected' then 'bg-red-100 text-red-800'
                    when 'ignored' then 'bg-gray-100 text-gray-800'
                    when 'exported' then 'bg-purple-100 text-purple-800'
                    end %>">
                    <%= job.status.titleize %>
                  </span>
                <% end %>
              </div>
              <p class="text-gray-700 font-medium mb-1"><%= job.company %></p>
              <p class="text-sm text-gray-600 mb-3">
                <% if job.location.present? %>
                  üìç <%= job.location %>
                <% end %>
                <% if job.posted_at %>
                  ‚Ä¢ Posted <%= time_ago_in_words(job.posted_at) %> ago
                <% end %>
              </p>
              <p class="text-gray-700 text-sm"><%= job.summary %></p>
            </div>
            <div class="ml-4 flex flex-col gap-2">
              <%= link_to "Apply ‚Üí", job.url, target: "_blank", rel: "noopener noreferrer", class: "px-4 py-2 text-white font-semibold rounded-lg transition-colors whitespace-nowrap text-center", style: "background-color: #16a34a;" %>
              
              <% if job.generated_today? %>
                <!-- Already generated today -->
                <div class="px-4 py-2 bg-green-100 text-green-800 font-semibold rounded-lg whitespace-nowrap text-center text-sm">
                  ‚úì Generated <%= time_ago_in_words(job.exported_at) %> ago
                </div>
                <% if job.latest_application&.output_path.present? %>
                  <%= link_to "View PDFs", application_path(job.latest_application), class: "px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors whitespace-nowrap text-center" %>
                <% else %>
                  <%= button_to "Generate Again", tailor_job_path(job), method: :post, class: "px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors whitespace-nowrap" %>
                <% end %>
              <% else %>
                <!-- Not generated yet -->
                <%= button_to "Tailor & Export", tailor_job_path(job), method: :post, class: "px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors whitespace-nowrap" %>
              <% end %>
              
              <div class="flex gap-1 flex-wrap">
                <%= button_to "Applied", applied_job_path(job), method: :patch, class: "px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors", title: "Mark as applied (a)" %>
                <%= button_to "Reject", rejected_job_path(job), method: :patch, class: "px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors", title: "Reject this job (r)" %>
                <%= button_to "Ignore", ignore_job_path(job), method: :patch, class: "px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 transition-colors", title: "Ignore this job (i)" %>
                <%= button_to "Block", filters_block_company_path, method: :post, params: { company_name: job.company }, class: "px-3 py-1 bg-red-800 text-white text-sm rounded hover:bg-red-900 transition-colors", confirm: "Block all jobs from #{job.company}?" %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-12 text-center">
      <p class="text-gray-600 text-lg mb-2">No jobs found</p>
      <p class="text-gray-500 text-sm">Run <code class="bg-white px-2 py-1 rounded">rake jobs:fetch</code> to import job postings.</p>
    </div>
  <% end %>
</div>

